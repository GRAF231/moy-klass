# Интеграция с CRM "Мой класс"

Данный проект представляет собой интеграцию с CRM "Мой класс" для автоматизации процессов, связанных с уроками:
1. Создание перерывов между уроками
2. Назначение аудиторий для индивидуальных занятий

## Требования

- PHP 7.2 или выше
- Доступ к CRM "Мой класс" и API-ключ
- Хостинг с поддержкой cron-задач (fornex с cPanel)

## Установка

1. Скопируйте все файлы проекта в директорию на вашем хостинге
2. Откройте файл `config/config.php` и настройте следующие параметры:
   - `api_url` - URL API CRM "Мой класс"
   - `api_key` - Ваш API-ключ
   - `main_classroom_id` - ID аудитории "Основная"
   - `zoom_classroom_ids` - Массив с ID аудиторий для Zoom (ID => имя)
   - `admin_user_id` - ID администратора для создания задач
   - `webhook_secret` - Секретный ключ для защиты веб-хуков (по желанию)

3. Настройте веб-хуки в CRM "Мой класс":
   - Создайте веб-хуки для событий `lesson.created` и `lesson.deleted`
   - Укажите URL вашего обработчика: `https://ваш-домен.ru/путь-к-проекту/webhooks/lesson_webhook.php`
   - Если вы указали `webhook_secret` в конфигурации, добавьте заголовок `Authorization: Bearer ваш-секретный-ключ` в настройках веб-хука

4. Настройте cron-задачи на хостинге:
   - Войдите в cPanel
   - Найдите раздел "Расширенные" и выберите "Планировщик заданий" (Cron Jobs)
   - Добавьте новую задачу:
     - Периодичность: */15 * * * * (каждые 15 минут)
     - Команда: php /полный/путь/к/вашему/проекту/my-class-api/cron/process_lessons.php

## Структура проекта

- `config/` - Конфигурационные файлы
  - `config.php` - Основной конфигурационный файл
- `src/` - Исходный код
  - `Api.php` - Класс для работы с API
  - `BreakManager.php` - Класс для управления перерывами
  - `ClassroomManager.php` - Класс для управления аудиториями
  - `autoload.php` - Автозагрузка классов
- `webhooks/` - Обработчики веб-хуков
  - `lesson_webhook.php` - Обработчик событий уроков
- `cron/` - Скрипты для планировщика задач
  - `process_lessons.php` - Скрипт для периодической обработки уроков
- `logs/` - Директория для логов (создается автоматически)

## Логирование

Все действия системы логируются в файлы в директории `logs/`. Для каждого дня создается отдельный файл в формате `api_YYYY-MM-DD.log`.

## Поддержка и обновление

При возникновении проблем вы можете:
1. Проверить логи в директории `logs/`
2. Обратиться к разработчику для получения поддержки

## Тестирование

Для проверки работы интеграции можно:

1. Создать тестовый урок в CRM и проверить, создался ли перерыв
2. Создать индивидуальный урок в аудитории "Основная" и проверить, назначилась ли аудитория Zoom
3. Запустить cron-скрипт вручную и проверить результаты:
   ```
   php /путь/к/проекту/my-class-api/cron/process_lessons.php
   ```
   или через браузер: `https://ваш-домен.ru/путь-к-проекту/cron/process_lessons.php?key=YOUR_SECRET_KEY`

## Особенности работы на хостинге fornex с cPanel

- Для настройки cron-задач используйте интерфейс cPanel -> Планировщик заданий
- Убедитесь, что у файлов проекта достаточно прав для выполнения (644 для файлов, 755 для директорий)
- Для PHP-скриптов используйте полный путь к интерпретатору PHP, например: `/usr/bin/php`
